# HotStuff-rs 0.2

## Things 

- Network. Functionality captured by the NetworkProvider trait:
```rust
trait NetworkProvider: Send + Sync {
    fn connect(peer: ValidatorAddress);
    fn disconnect(peer: ValidatorAddress);
    fn send(peer: Replica, msg: Message);
    fn broadcast(msg: Message);
    fn receive(timeout: Timeout) -> Option<Message>;
}
```

- Messages. Two kinds: Sync Messages, and Progress Messages.
```rust
enum Message {
    Sync(SyncMessage),
    Progress(ProgressMessage),
}

enum SyncMessage {
    Request {
        highest_committed_block: BlockHash,
        limit: u32,
    },
    Response {
        blocks: Vec<Block>,
        tail_qcs: Vec<QuorumCertificate>,
    }
}

enum ProgressMessage {
    Propose {
        block: Block,
        vote: ProgressMessage,
    },
    Vote {
        view_num: ViewNumber,
        block_hash: BlockHash,
        phase: Phase,
        signature: Signature,
    },
}
```

- Message flows.

- Validator Set Updates.
```rust
type StateUpdates = Vec<StateUpdate>;
enum StateUpdate {
    Set {
        key: Vec<u8>,
        value: Vec<u8>,
    },
    Delete {
        key: Vec<u8>,
    },
}

type ValidatorSetUpdates = Vec<ValidatorSetUpdate>;
struct ValidatorSetUpdate {
    validator: ValidatorAddress,
    // power == 0 will delete the validator from the validator set.
    power: u64, 
}
```


- Phases. Either generic, or one of prepare/precommit/commit. 
```rust
enum Phase {
    Generic,
    Prepare,
    Precommit,
    Commit,
}

struct QuorumCertificate {
    view_num: ViewNumber,
    block_hash: BlockHash,
    phase: Phase,
    signatures: Vec<Option<Signature>>,
}
```

- Pacemaker.
```rust
mod pacemaker {
    fn wait_timeout(highest_qc_view_num: ViewNumber, cur_view: ViewNumber) -> Timeout;
    fn view_leader(validator_set: ValidatorSet, cur_view: ViewNumber) -> ValidatorAddress;
}
```

- App trait.
```rust
trait App {
    fn propose_block(request: ProposeBlockRequest) -> ProposeBlockResponse;
    fn validate_block(request: ValidateBlockRequest) -> ValidateBlockResponse;
}

struct ProposeBlockRequest {
    cur_view: ViewNumber,
    prev_block: BlockHash,
    block_tree: BlockTreeSnapshot,
}

struct ValidateBlockRequest {
    cur_view: ViewNumber,
    proposed_block: Block,
    block_tree: BlockTreeSnapshot,
}

struct ProposeBlockResponse {
    block: Block,
    state_updates: Option<StateUpdates>,
    validator_set_updates: Option<ValidatorSetUpdates>, 
}

enum ValidateBlockResponse {
    Valid {
        state_updates: Option<StateUpdates>,
        validator_set_updates: Option<ValidatorSetUpdates>,
    },
    Invalid,
}
```

## Overall message flow

Network ---[Messages]--> MessageFilter ---[Sync Requests]---> Sync Server ---[Sync Responses]---> Network
                                       ---[Progress Messages]---> Alice ---[Progress Messages]---> Network
                                                                        ---[Sync Requests]---> Network 